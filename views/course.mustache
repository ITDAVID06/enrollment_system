<div>
    <h2>Courses</h2>
    <div>
        <h3>College Programs</h3>
        <ul id="programList">
            {{#programs}}
            <li onclick="loadCoursesByProgramAndYear({{id}}, 1)">{{program_code}}</li>
            {{/programs}}
        </ul>
    </div>

    <div>
        <h3>Year Levels</h3>
        <button onclick="filterYear(1)">1st Year</button>
        <button onclick="filterYear(2)">2nd Year</button>
        <button onclick="filterYear(3)">3rd Year</button>
        <button onclick="filterYear(4)">4th Year</button>
    </div>

    <button id="addCourseButton">Add Course</button>

    <div id="addCourseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddCourseModal()">&times;</span>
        <h3>Add Course</h3>
        <form id="addCourseForm">
            <!-- Hidden fields for program_id and year -->
            <input type="hidden" id="addProgramId" name="program_id">
            <input type="hidden" id="addYear" name="year">

            <label for="courseCode">Course Code:</label>
            <input type="text" id="courseCode" name="course_code" required>

            <label for="courseTitle">Title:</label>
            <input type="text" id="courseTitle" name="title" required>

            <label for="courseUnit">Unit:</label>
            <input type="number" id="courseUnit" name="unit" required>

            <label for="courseSemester">Semester:</label>
            <select id="courseSemester" name="semester" required>
                <option value="1st Sem">1st Sem</option>
                <option value="2nd Sem">2nd Sem</option>
            </select>

            <button type="submit">Add Course</button>
        </form>
    </div>
</div>

<div id="editCourseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditCourseModal()">&times;</span>
        <h3>Edit Course</h3>
        <form id="editCourseForm">
            <!-- Hidden field for course ID -->
            <input type="hidden" id="editCourseId" name="id">

            <label for="editCourseCode">Course Code:</label>
            <input type="text" id="editCourseCode" name="course_code" required>

            <label for="editCourseTitle">Title:</label>
            <input type="text" id="editCourseTitle" name="title" required>

            <label for="editCourseUnit">Unit:</label>
            <input type="number" id="editCourseUnit" name="unit" required>

            <label for="editCourseSemester">Semester:</label>
            <select id="editCourseSemester" name="semester" required>
                <option value="1st Sem">1st Sem</option>
                <option value="2nd Sem">2nd Sem</option>
            </select>

            <label for="editCourseYear">Year:</label>
            <input type="number" id="editCourseYear" name="year" required readonly>

            <button type="submit">Update Course</button>
        </form>
    </div>
</div>


<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        padding-top: 100px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>



    <table border="1" id="courseTable">
        <thead>
            <tr>
                <th>Course Code</th>
                <th>Title</th>
                <th>Unit</th>
                <th>Semester</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Populated dynamically -->
        </tbody>
    </table>
</div>

<script>
    let currentProgramId = null;
    let currentYear = 1;

    const loadCoursesByProgramAndYear = async (programId, year) => {
        currentProgramId = programId;
        currentYear = year;

        const response = await fetch(`/courses/${programId}/${year}`);
        const courses = await response.json();

        const tableBody = document.querySelector("#courseTable tbody");
        tableBody.innerHTML = courses.map(course => `
            <tr>
                <td>${course.course_code}</td>
                <td>${course.title}</td>
                <td>${course.unit}</td>
                <td>${course.semester}</td>
                <td>
                    <button onclick="editCourse(${course.id})">Edit</button>
                    <button onclick="deleteCourse(${course.id})">Delete</button>
                </td>
            </tr>
        `).join("");
    };

    const filterYear = (year) => {
        if (currentProgramId) {
            loadCoursesByProgramAndYear(currentProgramId, year);
        }
    };

    const addCourseModal = document.getElementById("addCourseModal");

// Open the Add Course modal
document.getElementById("addCourseButton").onclick = () => {
    if (!currentProgramId || !currentYear) {
        alert("Please select a program and year first.");
        return;
    }

    // Pre-fill hidden fields
    document.getElementById("addProgramId").value = currentProgramId;
    document.getElementById("addYear").value = currentYear;

    addCourseModal.style.display = "block";
};

// Close Add Course modal
const closeAddCourseModal = () => {
    addCourseModal.style.display = "none";
};

// Handle Add Course form submission
document.getElementById("addCourseForm").onsubmit = async (event) => {
    event.preventDefault();
    const formData = new FormData(event.target);

    // Send data to backend
    await fetch("/course", {
        method: "POST",
        body: formData,
    });

    closeAddCourseModal();
    loadCoursesByProgramAndYear(currentProgramId, currentYear);
};


    const editCourseModal = document.getElementById("editCourseModal");

// Open the Edit Course modal
const editCourse = async (courseId) => {
    // Fetch course details from backend
    const response = await fetch(`/course/${courseId}`);
    const course = await response.json();

    // Pre-fill the form with course data
    document.getElementById("editCourseId").value = course.id;
    document.getElementById("editCourseCode").value = course.course_code;
    document.getElementById("editCourseTitle").value = course.title;
    document.getElementById("editCourseUnit").value = course.unit;
    document.getElementById("editCourseSemester").value = course.semester;
    document.getElementById("editCourseYear").value = course.year;

    editCourseModal.style.display = "block";
};

// Close Edit Course modal
const closeEditCourseModal = () => {
    editCourseModal.style.display = "none";
};

// Handle Edit Course form submission
document.getElementById("editCourseForm").onsubmit = async (event) => {
    event.preventDefault();
    const formData = new FormData(event.target);

    // Send updated data to backend
    await fetch(`/course/update/${formData.get("id")}`, {
        method: "POST",
        body: formData,
    });

    closeEditCourseModal();
    loadCoursesByProgramAndYear(currentProgramId, currentYear);
};

    
    const deleteCourse = async (id) => {
        if (confirm("Are you sure you want to delete this course?")) {
            await fetch(`/course/delete/${id}`, { method: "DELETE" });
            loadCoursesByProgramAndYear(currentProgramId, currentYear);
        }
    };

    loadCoursesByProgramAndYear(1, 1); // Default load
</script>
